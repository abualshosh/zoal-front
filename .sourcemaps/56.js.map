{"version":3,"sources":["../../src/pages/chat/messages/messages.module.ts","../../src/pages/chat/messages/messages.ts"],"names":[],"mappings":"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","file":"56.js","sourcesContent":["//import { SharedModule } from '../../../../app/shared.module';\r\nimport { MessagesPage } from './messages';\r\nimport { NgModule } from '@angular/core';\r\nimport { IonicPageModule } from 'ionic-angular';\r\n\r\n@NgModule({\r\n  declarations: [\r\n    MessagesPage,\r\n  ],\r\n  imports: [\r\n    IonicPageModule.forChild(MessagesPage),\r\n//    SharedModule,\r\n  ],\r\n  exports: [\r\n    MessagesPage\r\n  ]\r\n})\r\n\r\nexport class MessagesPageModule { }\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/chat/messages/messages.module.ts","import { FormControl, FormBuilder } from '@angular/forms';\r\nimport { Component, ViewChild } from '@angular/core';\r\nimport { IonicPage, NavController, Content, NavParams, } from 'ionic-angular';\r\nimport { Api,User } from '../../../providers/providers'\r\nimport { Events } from 'ionic-angular';\r\nimport { SQLite ,SQLiteObject  } from '@ionic-native/sqlite';\r\nimport { StompService } from 'ng2-stomp-service';\r\n@IonicPage()\r\n@Component({\r\n  selector: 'page-messages',\r\n  templateUrl: 'messages.html'\r\n})\r\nexport class MessagesPage {\r\n  toUser:any ;\r\nlast:boolean=false;\r\n  user:any;\r\nmessages:any=[];\r\n  doneLoading = false;\r\nlastindex:any=10;\r\n\r\n  @ViewChild(Content) contents: Content;\r\nCahtUser:string;\r\n  public messageForm: any;\r\n  chatBox: any;\r\n  mySubscribedHandler:any =  (greeting) => {\r\n\r\n    //    showGreeting(greeting.body);\r\n    console.log(greeting);\r\n  if (this.navCtrl.getActive().name == 'MessagesPage'&&greeting.sender==this.toUser._id) {\r\n    console.log(greeting);\r\n\r\n\r\n\r\n\r\n\r\n    this.messages.push({\r\n      toId: this.toUser._id,\r\n      _id: 6,\r\n      date: greeting.msgDate,\r\n      userId: this.toUser._id,\r\n      username: this.toUser.username,\r\n      pic: this.toUser.pic,\r\n      text: greeting.message    });\r\n\r\n  this.scrollToBottom();\r\n  }\r\n  }\r\n  constructor(\r\n    public stomp: StompService,\r\n    public sqlite:SQLite,public events: Events,public users:User,public navCtrl: NavController, public formBuilder: FormBuilder,public api:Api,navParams: NavParams,) {\r\nthis.CahtUser=navParams.get('otherUser');\r\n    this.user = {\r\n      _id: localStorage.getItem('username'),\r\n      pic: this.api.url+'/profileimage/'+localStorage.getItem('username'),\r\n      username: localStorage.getItem('username'),\r\n    };\r\n    this.toUser = {\r\n      _id: navParams.get('otherUser'),\r\n      pic: this.api.url+'/profileimage/'+navParams.get('otherUser'),\r\n      username: navParams.get('otherUser'),\r\n    };\r\nthis.messages=navParams.get('msg');\r\n\r\n\r\n\r\n    this.messageForm = formBuilder.group({\r\n      message: new FormControl('')\r\n    });\r\n    this.chatBox = '';\r\n\r\n    this.stomp.subscribe('/user/queue/status', this.response);\r\n    this.events.subscribe('message', this.mySubscribedHandler);\r\n  }\r\n  public response = (data) => {\r\n    console.log(data)\r\n        \r\n      }\r\n\r\n\r\nionViewWillLeave(){\r\n\r\n    this.events.unsubscribe('message', this.mySubscribedHandler);\r\n}\r\n  send(message) {\r\n    if (message && message !== '') {\r\n      // this.messageService.sendMessage(chatId, message);\r\n      var sender = this.user._id;\r\n      \tvar recipient = this.toUser._id;\r\n        var message = message;\r\n        var msgDate=new Date();\r\n        //  stompClient.send(\"/app/hello\", {}, JSON.stringify({ 'name': name }));\r\nthis.users.stomp.send(\"/app/message\",{ 'sender': sender,'recipient':recipient,'message':message ,msgDate:msgDate});\r\n//  this..send('destionation',{\"data\":\"data\"});\r\n      const messageData =\r\n        {\r\n          toId: this.toUser._id,\r\n          _id: 6,\r\n          date:msgDate ,\r\n          userId: this.user._id,\r\n          username: this.toUser.username,\r\n          pic: this.toUser.pic,\r\n          text: message\r\n        };\r\n\r\n  this.sqlite.create({\r\n        name: localStorage.getItem('username'),\r\n        location: 'default'\r\n      })\r\n        .then((db: SQLiteObject) => {\r\n\r\n\r\n\r\n      db.executeSql(`insert into messages(\r\n           chatId ,\r\n           otherUser ,\r\n           msg ,\r\n           msgDate\r\n      ) values (?,?,?,?)`, [this.toUser.username,this.user._id,message,msgDate]);\r\n\r\n      db.executeSql(`update chats set msg=? , msgDate=? where otheruser=?`,\r\n      [message,msgDate,this.toUser.username]).then(data => {\r\n     if(data.rowsAffected == 0){\r\n       db.executeSql(`insert into chats(\r\n         otherUser ,\r\n         msg ,\r\n         msgDate\r\n    ) values (?,?,?)`, [this.toUser.username,message,msgDate]);\r\n    \r\n     }\r\n       }, (e) => {\r\n   \r\n   \r\n       console.log(\"Errot: \" + JSON.stringify(e));\r\n       });\r\n\r\n      // for(var i = 0; i < this.chats.length; i++)\r\n      // {\r\n      //   if(this.chats[i].title==greeting.sender){\r\n      //     this.chats[i].lastMessage=greeting.message;\r\n      //     this.chats[i].timestamp=new Date();\r\n      //   }\r\n      // }\r\n\r\n }).catch(e => console.log(e));\r\n\r\n\r\n      this.messages.push(messageData);\r\n      this.events.publish('sending',messageData);\r\n      this.scrollToBottom();\r\n\r\n      // setTimeout(() => {\r\n      //   const replyData =\r\n      //     {\r\n      //       toId: this.toUser._id,\r\n      //       _id: 6,\r\n      //       date: new Date(),\r\n      //       userId: this.toUser._id,\r\n      //       username: this.toUser.username,\r\n      //       pic: this.toUser.pic,\r\n      //       text: 'Just a quick reply'\r\n      //     };\r\n      //   this.messages.push(replyData);\r\n      //   this.scrollToBottom();\r\n      // }, 1000);\r\n    }\r\n    this.chatBox = '';\r\n  }\r\ndoInfinite(refresher){\r\nlet startindex=this.lastindex;\r\n  this.sqlite.create({\r\n    name: localStorage.getItem('username'),\r\n    location: 'default'\r\n  })\r\n    .then((db: SQLiteObject) => {\r\n  db.executeSql(\"SELECT * FROM messages where chatid=? order by id desc limit ? offset ?\", [this.CahtUser,10,this.lastindex]).then(data => {\r\n\r\n  if(data.rows.length > 0) {\r\n    for(var i = 0; i < data.rows.length; i++)\r\n    {\r\n      this.messages.splice(0,0,{\r\n        toId: data.rows.item(i).otherUser,\r\n        _id: 6,\r\n        date: new Date(),\r\n        userId: data.rows.item(i).otherUser,\r\n        username: data.rows.item(i).otherUser,\r\n        pic: this.api.url+'/profileimage/'+data.rows.item(i).otherUser,\r\n        text: data.rows.item(i).msg    });\r\nthis.lastindex++;\r\n    }\r\n\r\n  }\r\n  if(startindex==this.lastindex){\r\n    this.last=true;\r\n  }\r\n  refresher.complete();\r\n  }, (e) => {\r\n\r\n\r\n  console.log(\"Errot: \" + JSON.stringify(e));\r\n  });\r\n})\r\n.catch(e =>\r\nalert(JSON.stringify(e)));\r\n}\r\n  scrollToBottom() {\r\n    setTimeout(() => {\r\nif(this.contents){\r\n      this.contents.scrollToBottom();\r\n  }}, 500);\r\n  }\r\n\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/chat/messages/messages.ts"],"sourceRoot":""}